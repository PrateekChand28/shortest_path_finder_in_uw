#!/usr/bin/env bash

JUNITPATH="/libs/junit5.jar"
JUNITFXPATH="/libs/junit5fx.jar"

if [[ -f ${JUNITPATH} ]]; then
    cp ${JUNITPATH} ../
fi

if [[ -f ${JUNITFXPATH} ]]; then
    cp ${JUNITFXPATH} ../
fi

if [[ -d /javafx  ]]; then
    cp -r /javafx ../javafx
fi

if [[ ! -f Makefile ]]; then
	echo
	echo "Submission Failed Check: no Makefile found"
	exit 1
fi

if ! make -n startServer ; then
	echo
	echo "Submission Failed Check: Makefile does not include the target startServer"
	exit 1
fi

if ! make -n runAllTests ; then
    echo
    echo "Submission Failed Check: Makefile does not include the target runAllTests"
    exit 1
fi

if ! make -n clean ; then
    echo
    echo "Submission Failed Check: Makefile does not include the target clean"
    exit 1
fi

if grep -Pv '//' WebApp.java | grep -Pq "Placeholder"; then
    echo
    echo "Submission Failed Check: WebApp.java includes references to placeholder classes"
    exit 1
fi

if ! javac -encoding "UTF-8" -cp ../junit5.jar:. *.java; then
	echo
	echo "Submission Failed Check: cannot compile all java files in submission"
	exit 1
fi

if ! javac -cp ../junit5.jar:. *.java; then
	echo
	echo "Submission Failed Check: cannot compile all java files in submission"
	exit 1
fi

if ! java -jar ../junit5.jar --class-path=. --select-class=P210SubmissionChecker; then
	echo
	echo "Submission Failed Check: one or more JUnit tests failed; if you have submitted (pushed) 3 or more JUnit test methods then your submission is complete for the mid-week deadline"

if ! java -jar ../junit5.jar --class-path=. --select-class=P212SubmissionChecker; then
	echo
	echo "Submission Failed Check: one or more JUnit tests failed; if you have submitted (pushed) 5 or more JUnit test methods then your submission is complete for the mid-week deadline"
	exit 1
fi

echo

if [[ ! -f groupAndRole.txt ]]; then
  echo "Warning Submission Incomplete: submission does not contain groupAndRole.txt, which should not have been deleted."
  exit 1
fi

if [[ $(grep -c backend groupAndRole.txt) == 1 ]]; then
    ROLE=Backend
else
    if [[ $(grep -c frontend groupAndRole.txt) == 1 ]]; then
	ROLE=Frontend
    else
	>&2 echo "Warning Submission Incomplete: unable to find role stored in groupAndRole.txt file"
	exit 1;
    fi
fi

ROLEFILE="${ROLE}.java"
ROLEINTRF="${ROLE}Interface.java"

if [[ ! -f ${ROLEFILE} ]]; then
  echo "Warning Submission Incomplete: submission does not contain ${ROLEFILE}, but should"
  exit 1
fi

if ! grep -Pzq "implements[^\{]{1,100}${ROLEINTRF%\.java}" ${ROLEFILE}; then
  echo "Warning Submission Incomplete: ${ROLEFILE} does not implement ${ROLEINTRF%\.java}, but should"
  exit 1
fi

if ! javac -cp .:${JUNITPATH} ${ROLEFILE}; then
  echo "Warning Submission Incomplete: ${ROLEFILE} does not compile, but should"
  exit 1
fi

if [[ ! -f "${ROLE}Tests.java" ]]; then
  echo "Warning Submission Incomplete: submission does not contain ${ROLE}Tests.java file, but this is where your tests should be implemented"
  exit 1
fi

echo "Submission Passed Basic Scan"
#exit 0
